<!-- src/app/modules/students/students.component.html -->
<div class="students-page">

    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="pi pi-users"></i>
                    Estudiantes
                </h1>
                <p class="page-subtitle">Gestión de estudiantes del sistema</p>
            </div>
            <button pButton icon="pi pi-plus" label="Nuevo Estudiante" class="p-button-primary" (click)="openCreate()">
            </button>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="filters-card">
        <div class="filters-header">
            <h3 class="filters-title">
                <i class="pi pi-filter"></i>
                Filtros
            </h3>
            @if (hasActiveFilters) {
            <button pButton icon="pi pi-filter-slash" label="Limpiar" class="p-button-text p-button-sm"
                (click)="clearFilters()">
            </button>
            }
        </div>

        <div class="filters-content">
            <!-- Search -->
            <div class="filter-item filter-search">
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input type="text" pInputText placeholder="Buscar por nombre, matrícula, CI o email..."
                        [(ngModel)]="searchQuery" (keyup.enter)="onSearch()" class="w-full" />
                </span>
            </div>

            <!-- Grade Filter -->
            <div class="filter-item">
                <p-select [options]="grades()" [(ngModel)]="selectedGrade" optionLabel="name" optionValue="idGrade"
                    placeholder="Grado" [showClear]="true" (onChange)="onFilterChange()" styleClass="w-full">
                </p-select>
            </div>

            <!-- Status Filter -->
            <div class="filter-item">
                <p-select [options]="statusOptions" [(ngModel)]="selectedStatus" optionLabel="label" optionValue="value"
                    placeholder="Estado" [showClear]="true" (onChange)="onFilterChange()" styleClass="w-full">
                </p-select>
            </div>

            <!-- Search Button -->
            <div class="filter-item">
                <button pButton icon="pi pi-search" label="Buscar" class="p-button-primary w-full" (click)="onSearch()">
                </button>
            </div>
        </div>
    </div>

    <!-- Actions Bar -->
    <div class="actions-bar">
        <div class="actions-left">
            @if (!loading()) {
            <span class="results-count">
                <i class="pi pi-users"></i>
                {{ totalRecords() }} estudiante(s) encontrado(s)
            </span>
            }
        </div>
        <div class="actions-right">
            <button pButton icon="pi pi-refresh" label="Actualizar" class="p-button-outlined p-button-sm"
                (click)="loadStudents()" [disabled]="loading()">
            </button>
            <button pButton icon="pi pi-file-excel" label="Exportar"
                class="p-button-success p-button-outlined p-button-sm" (click)="exportToExcel()">
            </button>
        </div>
    </div>

    <!-- Data Table -->
    <div class="table-card">
        <p-table [value]="students()" [loading]="loading()" [paginator]="true" [rows]="pageSize"
            [totalRecords]="totalRecords()" [lazy]="true" (onLazyLoad)="onPageChange($event)"
            [rowsPerPageOptions]="pageSizeOptions" [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} estudiantes" dataKey="idStudent"
            styleClass="p-datatable-striped" responsiveLayout="scroll">

            <!-- Loading skeleton -->
            <ng-template pTemplate="loadingbody">
                <tr *ngFor="let i of [1,2,3,4,5]">
                    <td colspan="7">
                        <p-skeleton height="2.5rem" styleClass="mb-1" />
                    </td>
                </tr>
            </ng-template>

            <!-- Header -->
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 80px">Avatar</th>
                    <th pSortableColumn="enrollmentNumber">
                        Matrícula <p-sortIcon field="enrollmentNumber" />
                    </th>
                    <th pSortableColumn="fullName">
                        Nombre <p-sortIcon field="fullName" />
                    </th>
                    <th>Grado / Sección</th>
                    <th>Contacto</th>
                    <th style="width: 110px; text-align:center">Estado</th>
                    <th style="width: 180px; text-align:center">Acciones</th>
                </tr>
            </ng-template>

            <!-- Body -->
            <ng-template pTemplate="body" let-student>
                <tr>
                    <!-- Avatar -->
                    <td>
                        <div class="student-avatar" (click)="openDetail(student)">
                            <div class="avatar-placeholder">
                                <i class="pi pi-user"></i>
                            </div>
                        </div>
                    </td>

                    <!-- Matrícula -->
                    <td>
                        <span class="student-code">{{ student.enrollmentNumber }}</span>
                    </td>

                    <!-- Nombre + CI -->
                    <td>
                        <div class="student-name-cell" (click)="openDetail(student)">
                            <div class="student-name">{{ student.fullName }}</div>
                            <div class="student-sub">
                                {{ student.person.documentType }}: {{ student.person.documentNumber }}
                            </div>
                        </div>
                    </td>

                    <!-- Grado / Sección -->
                    <td>
                        <span class="grade-badge">{{ student.gradeName }} – {{ student.sectionName }}</span>
                        <div class="student-sub mt-1">{{ student.gradeLevel }}</div>
                    </td>

                    <!-- Contacto -->
                    <td>
                        @if (student.person.mobilePhone) {
                        <div class="student-sub">
                            <i class="pi pi-phone mr-1"></i>{{ student.person.mobilePhone }}
                        </div>
                        }
                        @if (student.person.email) {
                        <a [href]="'mailto:' + student.person.email" class="student-email">
                            {{ student.person.email }}
                        </a>
                        }
                    </td>

                    <!-- Estado -->
                    <td class="text-center">
                        <p-tag [value]="getStatusLabel(student.status)"
                            [severity]="getStatusSeverity(student.status)" />
                    </td>

                    <!-- Acciones -->
                    <td>
                        <div class="action-buttons">
                            <button pButton icon="pi pi-eye" class="p-button-rounded p-button-text p-button-info"
                                (click)="openDetail(student)" pTooltip="Ver detalle" tooltipPosition="top">
                            </button>

                            <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-warning"
                                (click)="openEdit(student)" pTooltip="Editar" tooltipPosition="top">
                            </button>

                            <button pButton [icon]="student.status === 'ACTIVE' ? 'pi pi-ban' : 'pi pi-check'"
                                class="p-button-rounded p-button-text"
                                [ngClass]="student.status === 'ACTIVE' ? 'p-button-secondary' : 'p-button-success'"
                                (click)="toggleStatus(student)"
                                [pTooltip]="student.status === 'ACTIVE' ? 'Desactivar' : 'Activar'"
                                tooltipPosition="top">
                            </button>

                            <button pButton icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger"
                                (click)="deleteStudent(student)" pTooltip="Eliminar" tooltipPosition="top">
                            </button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <!-- Empty -->
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <i class="pi pi-users"></i>
                            <h3>No se encontraron estudiantes</h3>
                            <p>No hay estudiantes que coincidan con los filtros aplicados</p>
                            <button pButton icon="pi pi-plus" label="Agregar Estudiante" class="p-button-primary"
                                (click)="openCreate()">
                            </button>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- Toast -->
<p-toast position="top-right" />

<!-- Confirm Dialog -->
<p-confirmDialog />

<!-- ── Modales ──────────────────────────────────────────────────────────────── -->

<!-- Form Dialog: Crear / Editar -->
<app-student-form-dialog [visible]="showFormDialog()" [studentId]="selectedStudentId()" (onSave)="onFormSaved()"
    (onClose)="onFormClosed()" />

<!-- Detail Dialog: Historial / Detalle -->
<app-student-detail-dialog [visible]="showDetailDialog()" [studentId]="selectedStudentId()" (onEdit)="openEdit($event)"
    (onClose)="onDetailClosed()" />