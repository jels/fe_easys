<!-- src/app/modules/credentials/credentials.component.html -->
<div class="cred-page">

    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title"><i class="pi pi-id-card"></i> Credenciales</h1>
            <p class="page-subtitle">Generación e impresión de carnets con QR de acceso</p>
        </div>
    </div>

    <div class="cred-layout">

        <!-- ── Panel izquierdo: Búsqueda ───────────────────────────────────── -->
        <div class="search-panel">
            <div class="search-panel-header">
                <span class="panel-label">Buscar persona</span>
            </div>

            <!-- Filtro tipo -->
            <p-selectButton [options]="typeOptions" [(ngModel)]="personType" optionLabel="label" optionValue="value"
                (onChange)="onTypeChange()" styleClass="type-select w-full mb-3" />

            <!-- Input búsqueda -->
            <div class="search-input-wrap">
                <i class="pi pi-search"></i>
                <input type="text" [(ngModel)]="searchText" (input)="onSearchInput()"
                    placeholder="Nombre o código..." />
            </div>

            <!-- Resultados -->
            <div class="search-results">
                @if (loadingSearch()) {
                @for (i of [1,2,3,4]; track i) {
                <div class="result-skeleton">
                    <p-skeleton shape="circle" size="2.5rem" />
                    <div class="skel-lines">
                        <p-skeleton width="70%" height="0.8rem" />
                        <p-skeleton width="45%" height="0.65rem" />
                    </div>
                </div>
                }
                } @else if (searchResults().length === 0) {
                <div class="empty-search">
                    <i class="pi pi-user-minus"></i>
                    <p>Sin resultados</p>
                </div>
                } @else {
                @for (person of searchResults(); track person.idPerson + person.personType) {
                <div class="result-item"
                    [class.selected]="selectedPerson()?.idPerson === person.idPerson && selectedPerson()?.personType === person.personType"
                    (click)="selectPerson(person)">
                    <!-- Avatar -->
                    <div class="result-avatar">
                        @if (person.photoUrl) {
                        <img [src]="person.photoUrl" [alt]="person.fullName" />
                        } @else {
                        <span>{{ getInitials(person.fullName) }}</span>
                        }
                    </div>
                    <!-- Info -->
                    <div class="result-info">
                        <span class="result-name">{{ person.fullName }}</span>
                        <span class="result-label">{{ person.displayLabel }}</span>
                    </div>
                    <!-- Estado credencial -->
                    <div class="result-badges">
                        <p-tag [value]="getTypeLabel(person.personType)" [severity]="getTypeSeverity(person.personType)"
                            styleClass="text-xs" />
                        @if (hasCredential(person)) {
                        <i class="pi pi-check-circle result-has-cred" pTooltip="Credencial emitida"></i>
                        } @else {
                        <i class="pi pi-minus-circle result-no-cred" pTooltip="Sin credencial"></i>
                        }
                    </div>
                </div>
                }
                }
            </div>
        </div>

        <!-- ── Panel derecho: Vista previa + acciones ───────────────────────── -->
        <div class="preview-panel">

            @if (!selectedPerson()) {
            <!-- Estado vacío -->
            <div class="empty-preview">
                <i class="pi pi-id-card"></i>
                <h3>Seleccioná una persona</h3>
                <p>Buscá y seleccioná un alumno o personal para generar su credencial</p>
            </div>

            } @else {
            <!-- Info de la persona -->
            <div class="person-info-bar">
                <div class="person-info-left">
                    <div class="person-avatar-lg">
                        @if (selectedPerson()!.photoUrl) {
                        <img [src]="selectedPerson()!.photoUrl" [alt]="selectedPerson()!.fullName" />
                        } @else {
                        <span>{{ getInitials(selectedPerson()!.fullName) }}</span>
                        }
                    </div>
                    <div>
                        <h2 class="person-name">{{ selectedPerson()!.fullName }}</h2>
                        <p class="person-label">{{ selectedPerson()!.displayLabel }}</p>
                        @if (selectedPerson()!.credentialIssuedAt) {
                        <p class="person-issued">
                            <i class="pi pi-calendar"></i>
                            Último carnet: {{ selectedPerson()!.credentialIssuedAt | date:'dd/MM/yyyy HH:mm' }}
                        </p>
                        }
                    </div>
                </div>
                <div class="person-info-actions">
                    <button pButton [label]="hasCredential(selectedPerson()!) ? 'Regenerar carnet' : 'Generar carnet'"
                        [icon]="hasCredential(selectedPerson()!) ? 'pi pi-refresh' : 'pi pi-id-card'"
                        [severity]="hasCredential(selectedPerson()!) ? 'warn' : 'primary'" [loading]="generatingCred()"
                        (click)="generate()"></button>
                    @if (printReady() && credentialData()) {
                    <button pButton label="Imprimir" icon="pi pi-print" severity="secondary" [outlined]="true"
                        (click)="print()"></button>
                    }
                </div>
            </div>

            @if (loadingCred()) {
            <div class="loading-cred">
                <p-skeleton width="430px" height="270px" borderRadius="0.5rem" />
            </div>
            }

            <!-- Credencial preview -->
            @if (credentialData(); as cd) {
            <div class="credential-preview-wrap">
                <div class="preview-label">Vista previa del carnet</div>

                <!-- ════ CARNET — El PNG es la base visual, solo se superponen los datos ════ -->
                <div class="credential-card" id="credential-print-area" #credentialRef>

                    <!-- Institución: topbar derecha (ya hay franja en PNG) -->
                    <div class="cred-institution">{{ cd.institution }}</div>

                    <!-- Foto circular: superpuesta sobre el círculo del PNG -->
                    <div class="cred-photo-circle">
                        @if (cd.person.photoUrl) {
                        <img [src]="cd.person.photoUrl" [alt]="cd.person.fullName" />
                        } @else {
                        <span class="cred-initials">{{ getInitials(cd.person.fullName) }}</span>
                        }
                    </div>

                    <!-- Valor del nombre (el label "Nombre:" ya está en el PNG) -->
                    <span class="cred-value-name">{{ cd.person.fullName }}</span>

                    <!-- Valor del grado/cargo (el label "Grado/Curso:" ya está en el PNG) -->
                    <span class="cred-value-grade">{{ cd.person.displayLabel }}</span>

                    <!-- Año lectivo -->
                    <span class="cred-value-year">{{ cd.activeYear }}</span>

                    <!-- QR: superpuesto sobre el cuadro del PNG (inferior derecha del panel navy) -->
                    <div class="cred-qr-wrap">
                        <qrcode [qrdata]="cd.accessToken" [width]="540" [margin]="1" errorCorrectionLevel="M"
                            [colorDark]="'#001b40'" [colorLight]="'#ffffff'" />
                    </div>

                </div><!-- /credential-card -->

                <!-- Token info (fuera del carnet, solo en pantalla) -->
                <div class="token-info">
                    <i class="pi pi-key"></i>
                    <span class="token-label">Token activo:</span>
                    <code class="token-value">{{ cd.accessToken }}</code>
                    @if (cd.isNew) {
                    <span class="token-new-badge">NUEVO</span>
                    }
                </div>
            </div>
            }
            }
        </div>

    </div><!-- /cred-layout -->
</div>

<p-confirmDialog />
<p-toast position="top-right" />