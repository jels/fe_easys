<!-- src/app/modules/mobile/qr-scanner/qr-scanner.component.html -->
<div class="scanner-page" [style.--mode-color]="modeColor()">

    <!-- Header -->
    <div class="scanner-header">
        <button class="btn-back" (click)="finalize()">
            <span>‚Äπ</span>
        </button>
        <div class="header-center">
            <span class="header-mode-icon">{{ currentConfig.icon }}</span>
            <span class="header-title">{{ modeLabel() }}</span>
        </div>
        <div class="scan-counter">
            <span class="count-num">{{ scanCount() }}</span>
            <span class="count-lbl">escaneados</span>
        </div>
    </div>

    <!-- Selector modo de acceso -->
    <div class="mode-selector">
        <button class="mode-btn" [class.active]="mode() === 'ENTRADA'" (click)="setMode('ENTRADA')">
            <span>üü¢</span> Entrada
        </button>
        <button class="mode-btn" [class.active]="mode() === 'RETIRO'" (click)="setMode('RETIRO')">
            <span>üü°</span> Retiro
        </button>
        <button class="mode-btn" [class.active]="mode() === 'SALIDA'" (click)="setMode('SALIDA')">
            <span>üî¥</span> Salida
        </button>
    </div>

    <!-- ‚îÄ‚îÄ Selector QR / NFC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="read-mode-selector">
        <button class="read-mode-btn" [class.active]="readMode() === 'QR'" (click)="switchReadMode('QR')">
            <span class="read-mode-icon">üì∑</span>
            <span class="read-mode-label">C√°mara QR</span>
        </button>

        <button class="read-mode-btn" [class.active]="readMode() === 'NFC'" [class.unsupported]="!nfcSupported"
            [disabled]="!nfcSupported" (click)="switchReadMode('NFC')">
            <span class="read-mode-icon">üì°</span>
            <span class="read-mode-label">Tap NFC</span>
            @if (!nfcSupported) {
            <span class="read-mode-unavail">No disponible</span>
            }
        </button>
    </div>

    <!-- ‚îÄ‚îÄ Viewport QR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    @if (readMode() === 'QR') {
    <div class="scanner-viewport" [class.flash-green]="flashActive()">

        @if (!hasCamera()) {
        <div class="no-camera">
            <span class="no-camera-icon">üì∑</span>
            <p>No se detect√≥ c√°mara</p>
            <small>Asegurate de dar permisos de c√°mara</small>
        </div>
        } @else {
        <zxing-scanner [enable]="scannerEnabled()" [device]="selectedCamera()" [formats]="formats"
            (camerasFound)="onCamerasFound($event)" (camerasNotFound)="onCamerasNotFound()"
            (scanSuccess)="onCodeScanned($event)" (scanError)="onScanError($event)" [style.width]="'100%'"
            [style.height]="'100%'">
        </zxing-scanner>

        <!-- Marco de escaneo -->
        <div class="scan-frame">
            <div class="corner tl"></div>
            <div class="corner tr"></div>
            <div class="corner bl"></div>
            <div class="corner br"></div>
            <div class="scan-line"></div>
        </div>

        <div class="scan-hint">
            <span>Apunt√° al c√≥digo QR del carnet</span>
        </div>
        }
    </div>
    }

    <!-- ‚îÄ‚îÄ Viewport NFC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    @if (readMode() === 'NFC') {
    <div class="nfc-viewport" [class.nfc-active]="nfcActive()" [class.flash-green]="flashActive()">

        <!-- Animaci√≥n de ondas -->
        <div class="nfc-waves">
            <div class="nfc-wave wave-1"></div>
            <div class="nfc-wave wave-2"></div>
            <div class="nfc-wave wave-3"></div>
            <div class="nfc-icon">
                @if (nfcActive()) {
                <span>üì°</span>
                } @else {
                <span>‚è≥</span>
                }
            </div>
        </div>

        <!-- Estado NFC -->
        <div class="nfc-status">
            @if (nfcActive()) {
            <div class="nfc-status-text active">
                <span class="nfc-dot"></span>
                NFC activo ‚Äî acerc√° la tarjeta
            </div>
            } @else if (nfcError()) {
            <div class="nfc-status-text error">
                ‚ö†Ô∏è {{ nfcError() }}
            </div>
            } @else {
            <div class="nfc-status-text waiting">
                Iniciando NFC...
            </div>
            }
        </div>

        <!-- Error persistente con bot√≥n reintentar -->
        @if (nfcError() && !nfcActive()) {
        <button class="btn-retry-nfc" (click)="startNfc()">
            üîÑ Reintentar
        </button>
        }

    </div>
    }

    <!-- ‚îÄ‚îÄ Feedback overlay (com√∫n QR + NFC) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    @if (feedback().visible) {
    <div class="feedback-overlay" [class.feedback-success]="feedback().success"
        [class.feedback-error]="!feedback().success">
        <div class="feedback-header">
            <span class="feedback-icon">{{ feedback().success ? '‚úÖ' : '‚ùå' }}</span>
            <span class="feedback-source-badge" [class.badge-nfc]="feedback().source === 'NFC'"
                [class.badge-qr]="feedback().source === 'QR'">
                {{ feedback().source === 'NFC' ? 'üì° NFC' : 'üì∑ QR' }}
            </span>
        </div>
        <div class="feedback-name">{{ feedback().name }}</div>
        @if (feedback().grade) {
        <div class="feedback-grade">{{ feedback().grade }}</div>
        }
        <div class="feedback-type-badge">{{ feedback().type }}</div>
        <div class="feedback-message">{{ feedback().message }}</div>
    </div>
    }

    <!-- Log de sesi√≥n -->
    @if (scanLog().length > 0) {
    <div class="session-log">
        <div class="session-log-title">Registros de esta sesi√≥n</div>
        <div class="session-log-list">
            @for (item of scanLog(); track $index) {
            <div class="log-item" [class.log-success]="item.success">
                <span class="log-icon">{{ item.success ? '‚úì' : '‚úó' }}</span>
                <span class="log-name">{{ item.name }}</span>
                <span class="log-source" [class.source-nfc]="item.source === 'NFC'">
                    {{ item.source }}
                </span>
                <span class="log-time">{{ item.time }}</span>
            </div>
            }
        </div>
    </div>
    }

    <!-- Footer -->
    <div class="scanner-footer">
        <button class="btn-finalize" (click)="finalize()">
            Finalizar sesi√≥n
        </button>
    </div>

</div>