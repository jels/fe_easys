<!-- src/app/modules/access-control/access-control.component.html -->
<div class="access-page">

    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="pi pi-shield"></i>
                    Control de Acceso
                </h1>
                <p class="page-subtitle">Registro de entradas, salidas y eventos del día</p>
            </div>
            <div class="header-actions">
                <p-datepicker [(ngModel)]="selectedDate" (ngModelChange)="onDateChange()" dateFormat="dd/mm/yy"
                    [showIcon]="true" styleClass="date-picker-compact" />
                <button pButton icon="pi pi-refresh" label="Actualizar" class="p-button-outlined p-button-sm"
                    (click)="refreshAll()">
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    @if (stats()) {
    <div class="stats-grid">
        <div class="stat-card stat-present">
            <div class="stat-icon"><i class="pi pi-check-circle"></i></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats()!.studentsPresentToday }}</span>
                <span class="stat-label">Alumnos presentes</span>
            </div>
        </div>
        <div class="stat-card stat-absent">
            <div class="stat-icon"><i class="pi pi-times-circle"></i></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats()!.studentsAbsentToday }}</span>
                <span class="stat-label">Alumnos ausentes</span>
            </div>
        </div>
        <div class="stat-card stat-late">
            <div class="stat-icon"><i class="pi pi-clock"></i></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats()!.studentsLateToday }}</span>
                <span class="stat-label">Tardanzas hoy</span>
            </div>
        </div>
        <div class="stat-card stat-staff">
            <div class="stat-icon"><i class="pi pi-id-card"></i></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats()!.staffPresentToday }}</span>
                <span class="stat-label">Personal presente</span>
            </div>
        </div>
        <div class="stat-card stat-departure">
            <div class="stat-icon"><i class="pi pi-sign-out"></i></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats()!.earlyDeparturesToday }}</span>
                <span class="stat-label">Retiros anticipados</span>
            </div>
        </div>
        <div class="stat-card stat-infraction">
            <div class="stat-icon"><i class="pi pi-exclamation-triangle"></i></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats()!.infractionsPending }}</span>
                <span class="stat-label">Infracciones pendientes</span>
            </div>
        </div>
    </div>
    }

    <!-- Main Tabs -->
    <div class="tabs-card">
        <p-tabs [value]="activeTab()" (valueChange)="onTabChange($event?.toString() ?? '0')">
            <p-tablist>
                <p-tab value="0">
                    <i class="pi pi-users mr-1"></i>
                    Acceso Estudiantes
                    @if (studentLogs().length) {
                    <span class="tab-badge">{{ studentLogs().length }}</span>
                    }
                </p-tab>
                <p-tab value="1">
                    <i class="pi pi-id-card mr-1"></i>
                    Acceso Personal
                    @if (staffLogs().length) {
                    <span class="tab-badge tab-badge-green">{{ staffLogs().length }}</span>
                    }
                </p-tab>
                <p-tab value="2">
                    <i class="pi pi-times-circle mr-1"></i>
                    Ausentes
                    @if (absentStudents().length) {
                    <span class="tab-badge tab-badge-red">{{ absentStudents().length }}</span>
                    }
                </p-tab>
                <p-tab value="3">
                    <i class="pi pi-sign-out mr-1"></i>
                    Retiros Anticipados
                    @if (earlyDepartures().length) {
                    <span class="tab-badge tab-badge-orange">{{ earlyDepartures().length }}</span>
                    }
                </p-tab>
                <p-tab value="4">
                    <i class="pi pi-exclamation-circle mr-1"></i>
                    Infracciones
                    @if (infractions().length) {
                    <span class="tab-badge tab-badge-red">{{ infractions().length }}</span>
                    }
                </p-tab>
                <p-tab value="5">
                    <i class="pi pi-qrcode mr-1"></i>
                    Escáner QR
                    @if (qrScanCount()) {
                    <span class="tab-badge tab-badge-green">{{ qrScanCount() }}</span>
                    }
                </p-tab>
            </p-tablist>

            <p-tabpanels>

                <!-- ── TAB 1: Acceso Estudiantes ──────────────────────────── -->
                <p-tabpanel value="0">
                    <div class="tab-toolbar">
                        <div class="toolbar-left">
                            <span class="p-input-icon-left">
                                <i class="pi pi-search"></i>
                                <input type="text" pInputText placeholder="Buscar alumno..." [(ngModel)]="searchStudent"
                                    (keyup.enter)="onSearchStudent()" style="width: 260px" />
                            </span>
                        </div>
                        <div class="toolbar-right">
                            <button pButton icon="pi pi-plus" label="Registrar Entrada/Salida"
                                class="p-button-primary p-button-sm" (click)="openAccessStudent()">
                            </button>
                        </div>
                    </div>

                    <p-table [value]="studentLogs()" [loading]="loadingStudent()" styleClass="p-datatable-sm"
                        [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,25]" responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Alumno</th>
                                <th>Grado / Sección</th>
                                <th>Entrada</th>
                                <th>Salida</th>
                                <th class="text-center">Tardanza</th>
                                <th class="text-center">Estado</th>
                                <th>Observaciones</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-log>
                            <tr [class.row-absent]="log.isAbsent" [class.row-late]="log.isLate && !log.isAbsent">
                                <td>
                                    <div class="person-cell">
                                        <div class="person-name">{{ log.studentName }}</div>
                                        <div class="person-sub mono">{{ log.enrollmentNumber }}</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="grade-badge">{{ log.gradeName }} – {{ log.sectionName }}</span>
                                </td>
                                <td>
                                    <span class="time-value" [class.time-late]="log.isLate">
                                        {{ formatTime(log.entryTime) }}
                                    </span>
                                </td>
                                <td>
                                    <span class="time-value">{{ formatTime(log.exitTime) }}</span>
                                </td>
                                <td class="text-center">
                                    @if (log.isLate) {
                                    <p-tag value="Tardanza" severity="warn" />
                                    } @else {
                                    <i class="pi pi-check text-green-500"></i>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (log.isAbsent) {
                                    <p-tag [value]="log.absenceJustified ? 'Justificada' : 'Injustificada'"
                                        [severity]="log.absenceJustified ? 'info' : 'danger'" />
                                    } @else {
                                    <p-tag value="Presente" severity="success" />
                                    }
                                </td>
                                <td>
                                    <span class="obs-text">{{ log.observations ?? '–' }}</span>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="7">
                                    <div class="empty-tab">
                                        <i class="pi pi-users"></i>
                                        <p>Sin registros para esta fecha</p>
                                        <button pButton icon="pi pi-plus" label="Registrar ahora"
                                            class="p-button-primary p-button-sm" (click)="openAccessStudent()">
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabpanel>

                <!-- ── TAB 2: Acceso Personal ─────────────────────────────── -->
                <p-tabpanel value="1">
                    <div class="tab-toolbar">
                        <div class="toolbar-left">
                            <span class="p-input-icon-left">
                                <i class="pi pi-search"></i>
                                <input type="text" pInputText placeholder="Buscar empleado..." [(ngModel)]="searchStaff"
                                    (keyup.enter)="onSearchStaff()" style="width: 260px" />
                            </span>
                        </div>
                        <div class="toolbar-right">
                            <button pButton icon="pi pi-plus" label="Registrar Acceso Personal"
                                class="p-button-primary p-button-sm" (click)="openAccessStaff()">
                            </button>
                        </div>
                    </div>

                    <p-table [value]="staffLogs()" [loading]="loadingStaff()" styleClass="p-datatable-sm"
                        [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,25]" responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Empleado</th>
                                <th>Tipo</th>
                                <th>Entrada</th>
                                <th>Salida</th>
                                <th class="text-center">Tardanza</th>
                                <th class="text-center">Estado</th>
                                <th>Observaciones</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-log>
                            <tr [class.row-absent]="log.isAbsent" [class.row-late]="log.isLate && !log.isAbsent">
                                <td>
                                    <div class="person-cell">
                                        <div class="person-name">{{ log.staffName }}</div>
                                        <div class="person-sub mono">{{ log.employeeNumber }}</div>
                                    </div>
                                </td>
                                <td>
                                    <p-tag [value]="getStaffTypeLabel(log.staffType)"
                                        [severity]="getStaffTypeSeverity(log.staffType)" />
                                </td>
                                <td>
                                    <span class="time-value" [class.time-late]="log.isLate">
                                        {{ formatTime(log.entryTime) }}
                                    </span>
                                </td>
                                <td>
                                    <span class="time-value">{{ formatTime(log.exitTime) }}</span>
                                </td>
                                <td class="text-center">
                                    @if (log.isLate) {
                                    <p-tag value="Tardanza" severity="warn" />
                                    } @else {
                                    <i class="pi pi-check text-green-500"></i>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (log.isAbsent) {
                                    <p-tag [value]="log.absenceJustified ? 'Justificada' : 'Injustificada'"
                                        [severity]="log.absenceJustified ? 'info' : 'danger'" />
                                    } @else {
                                    <p-tag value="Presente" severity="success" />
                                    }
                                </td>
                                <td><span class="obs-text">{{ log.observations ?? '–' }}</span></td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="7">
                                    <div class="empty-tab">
                                        <i class="pi pi-id-card"></i>
                                        <p>Sin registros de personal para esta fecha</p>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabpanel>

                <!-- ── TAB 3: Ausentes del día ────────────────────────────── -->
                <p-tabpanel value="2">
                    @if (absentStudents().length === 0 && !loadingAbsents()) {
                    <div class="empty-tab success-empty">
                        <i class="pi pi-check-circle"></i>
                        <p>¡Sin ausentes registrados hoy!</p>
                    </div>
                    } @else {
                    <div class="absent-grid">
                        @for (log of absentStudents(); track log.idStudentAccessLog) {
                        <div class="absent-card" [class.justified]="log.absenceJustified">
                            <div class="absent-card-header">
                                <div class="absent-avatar">
                                    <i class="pi pi-user"></i>
                                </div>
                                <div class="absent-info">
                                    <div class="absent-name">{{ log.studentName }}</div>
                                    <!--<div class="absent-sub">{{ log.enrollmentNumber }}</div>-->
                                </div>
                                <p-tag [value]="log.absenceJustified ? 'Justificada' : 'Injustificada'"
                                    [severity]="log.absenceJustified ? 'info' : 'danger'" styleClass="text-xs" />
                            </div>
                            <div class="absent-grade">
                                {{ log.gradeName }} – {{ log.sectionName }}
                            </div>
                            @if (log.observations) {
                            <div class="absent-obs">{{ log.observations }}</div>
                            }
                        </div>
                        }
                    </div>
                    }
                </p-tabpanel>

                <!-- ── TAB 4: Retiros anticipados ─────────────────────────── -->
                <p-tabpanel value="3">
                    <div class="tab-toolbar">
                        <div class="toolbar-left">
                            <span class="p-input-icon-left">
                                <i class="pi pi-search"></i>
                                <input type="text" pInputText placeholder="Buscar alumno o persona que retira..."
                                    [(ngModel)]="searchDeps" (keyup.enter)="onSearchDeps()" style="width: 300px" />
                            </span>
                        </div>
                        <div class="toolbar-right">
                            <button pButton icon="pi pi-plus" label="Registrar Retiro"
                                class="p-button-warning p-button-sm" (click)="openDepartureDialog()">
                            </button>
                        </div>
                    </div>

                    <p-table [value]="earlyDepartures()" [loading]="loadingDeps()" styleClass="p-datatable-sm"
                        [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,25]" responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Alumno</th>
                                <th>Grado</th>
                                <th>Hora Retiro</th>
                                <th>Persona que Retira</th>
                                <th>Parentesco</th>
                                <th>Autorizado por</th>
                                <th>Motivo</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-dep>
                            <tr>
                                <td>
                                    <div class="person-cell">
                                        <div class="person-name">{{ dep.studentName }}</div>
                                        <div class="person-sub mono">{{ dep.enrollmentNumber }}</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="grade-badge">{{ dep.gradeName }} – {{ dep.sectionName }}</span>
                                </td>
                                <td>
                                    <span class="time-value">{{ formatDatetime(dep.departureDatetime) }}</span>
                                </td>
                                <td class="font-medium">{{ dep.pickupPersonName }}</td>
                                <td>{{ getRelationshipLabel(dep.pickupPersonRelationship) }}</td>
                                <td>{{ dep.authorizedByStaffName ?? '–' }}</td>
                                <td><span class="obs-text">{{ dep.reason ?? '–' }}</span></td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="7">
                                    <div class="empty-tab">
                                        <i class="pi pi-sign-out"></i>
                                        <p>Sin retiros anticipados para esta fecha</p>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabpanel>

                <!-- ── TAB 5: Infracciones ────────────────────────────────── -->
                <p-tabpanel value="4">
                    <div class="tab-toolbar">
                        <div class="toolbar-left">
                            <span class="p-input-icon-left">
                                <i class="pi pi-search"></i>
                                <input type="text" pInputText placeholder="Buscar alumno o tipo..."
                                    [(ngModel)]="searchInf" (keyup.enter)="onSearchInf()" style="width: 260px" />
                            </span>
                        </div>
                        <div class="toolbar-right">
                            <button pButton icon="pi pi-plus" label="Registrar Infracción"
                                class="p-button-danger p-button-sm" (click)="openInfractionDialog()">
                            </button>
                        </div>
                    </div>

                    <p-table [value]="infractions()" [loading]="loadingInf()" styleClass="p-datatable-sm"
                        [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,25]" responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Alumno</th>
                                <th>Grado</th>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Gravedad</th>
                                <th>Descripción</th>
                                <th>Sanción</th>
                                <th class="text-center">Padres</th>
                                <th class="text-center">Resuelto</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-inf>
                            <tr [class.row-resolved]="inf.resolved">
                                <td>
                                    <div class="person-cell">
                                        <div class="person-name">{{ inf.studentName }}</div>
                                        <div class="person-sub mono">{{ inf.enrollmentNumber }}</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="grade-badge">{{ inf.gradeName }} – {{ inf.sectionName }}</span>
                                </td>
                                <td>{{ inf.incidentDate }}</td>
                                <td class="font-medium">{{ inf.infractionTypeName }}</td>
                                <td>
                                    <p-tag [value]="getSeverityLabel(inf.severity ?? '')"
                                        [severity]="getSeverityTag(inf.severity ?? '')" />
                                </td>
                                <td><span class="obs-text">{{ inf.description }}</span></td>
                                <td><span class="obs-text">{{ inf.sanctionApplied ?? '–' }}</span></td>
                                <td class="text-center">
                                    <i
                                        [class]="inf.parentNotified ? 'pi pi-check-circle text-green-500' : 'pi pi-times-circle text-red-400'"></i>
                                </td>
                                <td class="text-center">
                                    @if (inf.resolved) {
                                    <p-tag value="Sí" severity="success" />
                                    } @else {
                                    <p-tag value="Pendiente" severity="warn" />
                                    }
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="9">
                                    <div class="empty-tab">
                                        <i class="pi pi-exclamation-circle"></i>
                                        <p>Sin infracciones registradas</p>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabpanel>


                <!-- ── TAB 6: Escáner QR ─────────────────────────────────── -->
                <p-tabpanel value="5">
                    <div class="qr-layout">

                        <!-- ── Panel cámara ──────────────────────────────── -->
                        <div class="qr-cam-panel">

                            <!-- Selector de modo -->
                            <div class="qr-mode-bar">
                                <button class="qr-mode-btn" [class.qr-mode-active-entrada]="qrScanMode() === 'ENTRADA'"
                                    (click)="setQrMode('ENTRADA')">
                                    <span class="qr-dot" style="background:#22c55e"></span>
                                    Registrar Entrada
                                </button>
                                <button class="qr-mode-btn" [class.qr-mode-active-retiro]="qrScanMode() === 'RETIRO'"
                                    (click)="setQrMode('RETIRO')">
                                    <span class="qr-dot" style="background:#f59e0b"></span>
                                    Registrar Retiro
                                </button>
                                <button class="qr-mode-btn" [class.qr-mode-active-salida]="qrScanMode() === 'SALIDA'"
                                    (click)="setQrMode('SALIDA')">
                                    <span class="qr-dot" style="background:#ef4444"></span>
                                    Registrar Salida
                                </button>
                            </div>

                            <!-- Viewport cámara -->
                            <div class="qr-viewport" [class.qr-flash-ok]="qrFlashOk()"
                                [class.qr-flash-err]="qrFlashErr()" [style.--mode-color]="getQrModeColor(qrScanMode())">

                                <!-- Sin cámara -->
                                @if (!qrHasCamera()) {
                                <div class="qr-no-cam">
                                    <i class="pi pi-camera"></i>
                                    <p>No se detectó cámara</p>
                                    <small>Revisá los permisos del navegador</small>
                                </div>
                                }

                                <!-- Scanner ZXing -->
                                <zxing-scanner [enable]="qrScannerActive()" [device]="qrSelectedCamera()"
                                    [formats]="qrFormats" (camerasFound)="onQrCamerasFound($event)"
                                    (camerasNotFound)="onQrCamerasNotFound()" (scanSuccess)="onQrCodeScanned($event)"
                                    (scanError)="onQrScanError($event)" style="width:100%;height:100%;display:block">
                                </zxing-scanner>

                                <!-- Marco QR animado -->
                                <div class="qr-frame">
                                    <span class="qr-corner tl"></span>
                                    <span class="qr-corner tr"></span>
                                    <span class="qr-corner bl"></span>
                                    <span class="qr-corner br"></span>
                                    <span class="qr-scan-line"></span>
                                </div>

                                <!-- Hint inferior -->
                                <div class="qr-hint">
                                    Apuntá al código QR del carnet
                                    · Modo: <strong>{{ getQrModeLabel(qrScanMode()) }}</strong>
                                </div>
                            </div>

                            <!-- Feedback del último escaneo -->
                            @if (qrScanResult(); as res) {
                            <div class="qr-feedback" [class.qr-ok]="res.success" [class.qr-err]="!res.success">
                                <span class="qr-fb-icon">{{ res.success ? '✅' : '❌' }}</span>
                                <div class="qr-fb-body">
                                    <div class="qr-fb-name">
                                        {{ res.success ? res.person?.fullName : 'QR no reconocido' }}
                                    </div>
                                    @if (res.success && res.person?.displayLabel) {
                                    <div class="qr-fb-grade">{{ res.person?.displayLabel }}</div>
                                    }
                                    <div class="qr-fb-mode">
                                        <span class="qr-mode-pill" [style.background]="getQrModeColor(qrScanMode())">
                                            {{ getQrModeLabel(qrScanMode()) }}
                                        </span>
                                        {{ res.message }}
                                    </div>
                                </div>
                            </div>
                            }

                            <!-- Barra inferior: stats + acciones -->
                            <div class="qr-bottom-bar">
                                <div class="qr-session-info">
                                    <span class="qr-session-num">{{ qrScanCount() }}</span>
                                    <span class="qr-session-lbl">registros en esta sesión</span>
                                </div>
                                <div class="qr-bottom-actions">
                                    <button pButton icon="pi pi-trash" label="Limpiar log"
                                        class="p-button-outlined p-button-sm p-button-secondary"
                                        [disabled]="qrScanLog().length === 0" (click)="clearQrLog()">
                                    </button>
                                    <button pButton icon="pi pi-pencil" label="Registro manual"
                                        class="p-button-outlined p-button-sm" (click)="openAccessStudent()">
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ── Panel log de sesión ────────────────────────── -->
                        <div class="qr-log-panel">
                            <div class="qr-log-header">
                                <i class="pi pi-list"></i>
                                <span>Registros de la sesión</span>
                                @if (qrScanLog().length) {
                                <span class="qr-log-count">{{ qrScanLog().length }}</span>
                                }
                            </div>

                            @if (qrScanLog().length === 0) {
                            <div class="qr-log-empty">
                                <i class="pi pi-qrcode"></i>
                                <p>Escaneá un carnet para comenzar</p>
                            </div>
                            } @else {
                            <div class="qr-log-list">
                                @for (item of qrScanLog(); track $index) {
                                <div class="qr-log-item" [class.log-ok]="item.success" [class.log-err]="!item.success">
                                    <div class="log-icon-wrap" [style.background]="getQrModeColor(item.mode) + '22'">
                                        <i class="pi" [class.pi-check]="item.success" [class.pi-times]="!item.success"
                                            [style.color]="item.success ? getQrModeColor(item.mode) : '#ef4444'"></i>
                                    </div>
                                    <div class="log-info">
                                        <div class="log-name">{{ item.name }}</div>
                                        <div class="log-grade">{{ item.grade }}</div>
                                    </div>
                                    <div class="log-right">
                                        <span class="log-mode-pill" [style.background]="getQrModeColor(item.mode)">
                                            {{ getQrModeLabel(item.mode) }}
                                        </span>
                                        <span class="log-time">{{ item.time }}</span>
                                    </div>
                                </div>
                                }
                            </div>
                            }
                        </div>

                    </div><!-- /qr-layout -->
                </p-tabpanel>

            </p-tabpanels>
        </p-tabs>
    </div>
</div>

<p-toast position="top-right" />

<!-- Modales -->
<app-access-log-dialog [visible]="showAccessDialog()" [type]="accessDialogType()" [students]="students" [staff]="staff"
    [defaultDate]="dateStr" (onSave)="onAccessSaved()" (onClose)="onDialogClosed()" />

<app-early-departure-dialog [visible]="showDepartureDialog()" [students]="students" [staff]="staff"
    [defaultDate]="dateStr" (onSave)="onDepartureSaved()" (onClose)="onDialogClosed()" />

<app-infraction-dialog [visible]="showInfractionDialog()" [students]="students" (onSave)="onInfractionSaved()"
    (onClose)="onDialogClosed()" />